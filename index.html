<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Special Garden</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        canvas { display: block; }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© (Ø§Ù„Ù‚Ù„Ø¨) */
        #intro-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: #000; }
        
        #enter-btn {
            display: none; position: absolute; top: 75%; left: 50%; transform: translate(-50%, -50%);
            padding: 15px 40px; font-size: 18px; background: transparent; color: #ff3264;
            border: 2px solid #ff3264; border-radius: 30px; cursor: pointer; z-index: 10000;
            transition: all 0.3s; font-weight: bold; text-transform: uppercase;
        }
        #enter-btn:hover { background: #ff3264; color: #fff; box-shadow: 0 0 20px #ff3264; }

        /* Ø²Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø§Ù„Ø¹Ø§Ø¦Ù… */
        #music-toggle {
            position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px;
            border-radius: 50%; background: rgba(255, 50, 100, 0.7); color: white;
            border: 2px solid #fff; cursor: pointer; z-index: 10001; display: none;
            align-items: center; justify-content: center; font-size: 20px;
            box-shadow: 0 0 15px rgba(255, 50, 100, 0.5); transition: 0.3s;
        }
        #music-toggle:hover { transform: scale(1.1); background: #ff3264; }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠ (3D) */
        #main-site { display: none; width: 100%; height: 100%; }
        #loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #333; z-index: 100; background: rgba(255,255,255,0.8); padding: 20px; border-radius: 10px;
        }
        #mediaOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; 
            opacity: 0; transition: opacity 0.4s ease;
        }
        #mediaBox {
            background: #fff; width: auto; max-width: 90%; border-radius: 20px; 
            text-align: center; transform: scale(0.8); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 15px 35px rgba(0,0,0,0.5); overflow: hidden;
        }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.150.1/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.150.1/examples/jsm/"
            }
        }
    </script>
</head>
<body>

<audio id="bg-music" src="music.mp3" loop></audio>
<button id="music-toggle">ğŸ”Š</button>

<div id="intro-container">
    <button id="enter-btn">Enter Site</button>
</div>

<div id="main-site">
    <div id="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ù‡Ø¯ ÙˆØ§Ù„Ø¨ÙŠØ¦Ø©...</div>
    <div id="mediaOverlay">
        <div id="mediaBox">
            <img id="displayImg" src="" style="max-width:500px; width:100%; height:auto; display:none;">
            <video id="displayVideo" controls style="max-width:800px; width:100%; height:auto; display:none; background:#000; aspect-ratio: 16/9;"></video>
            <div style="padding:15px; background:#fff; display: flex; justify-content: center; gap: 15px;">
                <button id="closeBtn" style="padding:10px 30px; background:#000; color:white; border:none; border-radius:25px; cursor:pointer; font-weight:bold;">Ø¥ØºÙ„Ø§Ù‚</button>
                <button id="linkBtn" style="padding:10px 30px; background:#ff4757; color:white; border:none; border-radius:25px; cursor:pointer; font-weight:bold;">open web</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>

<script>
/** ÙƒÙˆØ¯ Ø§Ù„Ù‚Ù„Ø¨ **/
let particles = [];
let heartTargetPoints = [];
const NUM_PARTICLES = 1000;
let animationPhase = 0; 
let counter = 0;
let textAlpha = 0;

function setup() {
    let cnv = createCanvas(windowWidth, windowHeight);
    cnv.parent('intro-container');
    for (let t = 0; t < TWO_PI; t += 0.01) {
        let x = 16 * pow(sin(t), 3);
        let y = -(13 * cos(t) - 5 * cos(2 * t) - 2 * cos(3 * t) - cos(4 * t));
        heartTargetPoints.push(createVector(x * 15 + width / 2, y * 15 + height / 2));
    }
    for (let i = 0; i < NUM_PARTICLES; i++) {
        particles.push(new Particle());
    }
}

function draw() {
    background(0, 0, 0, 25);
    counter++;
    if (counter > 80 && animationPhase === 0) animationPhase = 1;
    if (counter > 350 && animationPhase === 1) animationPhase = 2;

    blendMode(ADD); 
    for (let p of particles) {
        p.behaviors(); p.update(); p.show();
    }
    blendMode(BLEND);

    if (animationPhase === 2) {
        textAlign(CENTER, CENTER);
        fill(255, 50, 100, textAlpha);
        noStroke();
        textSize(50);
        text("I Love You", width / 2, height / 2 - 20);
        fill(200, 200, 200, textAlpha - 100); 
        textSize(22);
        text("fatomty", width / 2, height / 2 + 40);
        if (textAlpha < 255) textAlpha += 2;
        if (textAlpha > 200) document.getElementById('enter-btn').style.display = 'block';
    }
}

class Particle {
    constructor() {
        this.pos = createVector(random(width), height + random(100));
        this.vel = createVector(random(-1, 1), random(-2, -5));
        this.acc = createVector(0, 0);
        this.maxSpeed = random(3, 7);
        this.maxForce = 0.25;
        let colors = [color(255, 20, 147), color(255, 0, 0), color(200, 0, 255)];
        this.color = random(colors);
        this.history = [];
        this.target = random(heartTargetPoints);
    }
    behaviors() {
        if (animationPhase >= 1) {
            let arrive = this.arrive(this.target);
            let mouse = createVector(mouseX, mouseY);
            let flee = this.flee(mouse);
            arrive.mult(1); flee.mult(5);
            this.applyForce(arrive); this.applyForce(flee);
        }
    }
    applyForce(f) { this.acc.add(f); }
    update() {
        this.vel.add(this.acc); this.pos.add(this.vel); this.acc.mult(0);
        if (animationPhase === 2) {
            this.history.push(this.pos.copy());
            if (this.history.length > 8) this.history.splice(0, 1);
        }
    }
    arrive(target) {
        let desired = p5.Vector.sub(target, this.pos);
        let d = desired.mag();
        let speed = (d < 100) ? map(d, 0, 100, 0, this.maxSpeed) : this.maxSpeed;
        desired.setMag(speed);
        let steer = p5.Vector.sub(desired, this.vel);
        steer.limit(this.maxForce);
        return steer;
    }
    flee(target) {
        let desired = p5.Vector.sub(target, this.pos);
        let d = desired.mag();
        if (d < 60) {
            desired.setMag(this.maxSpeed); desired.mult(-1);
            let steer = p5.Vector.sub(desired, this.vel);
            steer.limit(this.maxForce * 3);
            return steer;
        } else return createVector(0, 0);
    }
    show() {
        stroke(this.color); strokeWeight(2.5); point(this.pos.x, this.pos.y);
        if (this.history.length > 1) {
            noFill(); strokeWeight(1); beginShape();
            for (let i = 0; i < this.history.length; i++) {
                let alpha = map(i, 0, this.history.length, 0, 80);
                let c = color(red(this.color), green(this.color), blue(this.color), alpha);
                stroke(c); vertex(this.history[i].x, this.history[i].y);
            }
            endShape();
        }
    }
}

function windowResized() { resizeCanvas(windowWidth, windowHeight); }

// Ù…Ù†Ø·Ù‚ Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰
const music = document.getElementById('bg-music');
const musicToggle = document.getElementById('music-toggle');

document.getElementById('enter-btn').onclick = function() {
    music.play().catch(e => console.log("Audio play failed"));
    musicToggle.style.display = 'flex'; // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
    document.getElementById('intro-container').style.display = 'none';
    document.getElementById('main-site').style.display = 'block';
    noLoop(); 
    initThreeJS(); 
};

musicToggle.onclick = function() {
    if (music.paused) {
        music.play();
        this.innerHTML = "ğŸ”Š";
        this.style.background = "rgba(255, 50, 100, 0.7)";
    } else {
        music.pause();
        this.innerHTML = "ğŸ”‡";
        this.style.background = "rgba(100, 100, 100, 0.7)";
    }
};
</script>

<script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    window.initThreeJS = function() {
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(2.5, 9, -0.1); 

        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5)); 
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.outputEncoding = THREE.sRGBEncoding;
        document.getElementById('main-site').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        const textureLoader = new THREE.TextureLoader();
        textureLoader.load('DayEnvironmentHDRI057_8K_TONEMAPPED.jpg', (texture) => {
            texture.mapping = THREE.EquirectangularReflectionMapping;
            scene.background = texture;
            scene.environment = texture;
        });

        const myImages = ['ImageFrame1.jpg', 'imageframe2.jpg', 'imageframe3.jpg', 'imageframe4.jpg']; 
        const myVideos = ['VideoScreen1.mp4', 'VideoScreen2.mp4'];
        const videoObjects = [];

        function createVideoTexture(src) {
            const video = document.createElement('video');
            video.src = src; video.loop = true; video.muted = true; video.playsInline = true;
            video.crossOrigin = "anonymous"; video.play();
            const vTex = new THREE.VideoTexture(video);
            vTex.flipY = false;
            return vTex;
        }

        let model;
        const dracoLoader = new DRACOLoader();
        dracoLoader.setDecoderPath('https://www.gstatic.com/draco/versioned/decoders/1.5.6/');
        const loader = new GLTFLoader();
        loader.setDRACOLoader(dracoLoader);

        loader.load('my_scene.glb', (gltf) => {
            model = gltf.scene;
            scene.add(model);
            document.getElementById('loading').style.display = 'none';
            model.traverse((child) => {
                if (child.isMesh && child.material) {
                    for (let i = 1; i <= 4; i++) {
                        if (child.material.name === `ImageFrame${i}`) {
                            const tex = textureLoader.load(myImages[i-1]);
                            tex.flipY = false;
                            child.material = new THREE.MeshBasicMaterial({ map: tex });
                        }
                    }
                    for (let i = 1; i <= 5; i++) {
                        if (child.material.name === `VideoScreen${i}`) {
                            const vTex = createVideoTexture(myVideos[i-1]);
                            child.material = new THREE.MeshBasicMaterial({ map: vTex });
                            videoObjects.push(vTex);
                        }
                    }
                }
            });
        });

        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('click', (event) => {
            if (document.getElementById('main-site').style.display === 'none') return;
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            if (!model) return;
            const intersects = raycaster.intersectObjects(model.children, true);
            if (intersects.length > 0) {
                const mName = intersects[0].object.material.name;
                const overlay = document.getElementById('mediaOverlay');
                const box = document.getElementById('mediaBox');
                const img = document.getElementById('displayImg');
                const video = document.getElementById('displayVideo');

                if (mName === 'fatma' || mName === 'fatma1') {
                    document.getElementById('linkBtn').style.display = 'none';
                    img.style.display = 'none';
                    video.style.display = 'block';
                    video.src = (mName === 'fatma') ? 'VideoScreen1.mp4' : 'VideoScreen2.mp4';
                    video.load();
                    video.oncanplay = () => {
                        overlay.style.display = 'flex';
                        setTimeout(() => { overlay.style.opacity = '1'; box.style.transform = 'scale(1)'; }, 10);
                        video.play();
                    };
                } else if (mName === 'card') {
                    document.getElementById('linkBtn').style.display = 'block';
                    video.style.display = 'none'; video.pause();
                    img.style.display = 'block'; img.src = 'card1.jpg';
                    overlay.style.display = 'flex';
                    setTimeout(() => { overlay.style.opacity = '1'; box.style.transform = 'scale(1)'; }, 10);
                }
            }
        });

        document.getElementById('closeBtn').onclick = function() {
            const overlay = document.getElementById('mediaOverlay');
            const box = document.getElementById('mediaBox');
            document.getElementById('displayVideo').pause();
            overlay.style.opacity = '0';
            box.style.transform = 'scale(0.8)';
            setTimeout(() => { overlay.style.display = 'none'; }, 400);
        };

        document.getElementById('linkBtn').onclick = function() {
            window.open('https://fahtomty.github.io/love_u/', '_blank');
        };

        function animate() {
            requestAnimationFrame(animate);
            videoObjects.forEach(vTex => { if (vTex) vTex.needsUpdate = true; });
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
    };
</script>
</body>
</html>
